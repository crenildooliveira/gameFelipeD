<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuadradoAndador</title>

    <style>
        * {
            padding:0;
            margin:0;
            border:0;
        }

        #tela {
            border: 20px solid rgb(5, 0, 46);
            background-color: cornsilk;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            width: 800px;
            height: 800px;
        }

    </style>
</head>
<body>

    <canvas id="tela" width="40" height="40"></canvas>
    
    <!--<script src="cliente.js"></script>-->
    <script>

        const tela = document.getElementById("tela");
                const context = tela.getContext("2d");
                const currentPlayerId = "player1";

                function createGame(){

                    const state = {
                        players: {
                            "player1": {x:1, y:1},
                            "player2": {x:9, y:9}
                        },
                        frutas:{
                            "fruta1": {x:3, y:1}
                        }
                    }

                    function movePlayer(command){
                        console.log(`game.movePlayer() -> Moving ${command.playerId} with ${command.keyPressed}`)

                        const acceptedMoves = {

                            w(player){
                                console.log("game.movePlayer().Up() -> Moving player Up")
                                
                                if(player.y > 0){
                                    player.y = player.y - 1;
                                }
                            
                            },
                            a(player){
                                console.log("Moving player Left")

                                if(player.x > 0){
                                    player.x = player.x - 1;
                                }
                            },
                            s(player){
                                console.log("Moving player Down")

                                if(player.y + 1 < tela.height){
                                    player.y = player.y + 1;
                                }
                            },
                            d(player){
                                console.log("Moving player Right")

                                if(player.x + 1 < tela.width){
                                    player.x = player.x + 1;
                                }
                            }
                        }
                        
                        const keyPressed = command.keyPressed;
                        const player = state.players[command.playerId]
                        const moveFunction = acceptedMoves[keyPressed]

                        if(moveFunction){

                            moveFunction(player)
                        }
                   
                    }

                    return {
                        movePlayer,
                        state
                    }

                }

            
                const game = createGame();
                const KeyboardListener = createKeyboardListener();
                KeyboardListener.subscribe(game.movePlayer)

                function createKeyboardListener() {

                    const state = {
                        observers: []
                    }

                    function subscribe(observerFunction){
                        state.observers.push(observerFunction)
                    }

                    function notifyAll(command) {

                        console.log(`keyboardListener -> Notifying ${state.observers.length} observers`)

                        for (const observerFunction of state.observers){
                            observerFunction(command)
                        }
                    }

                    document.addEventListener("keydown", handleKeydown)

                    function handleKeydown(event) {
                        const keyPressed = event.key;
                        
                        const command = {
                            playerId: "player1",
                            keyPressed
                        }

                        notifyAll(command)
                    }

                    return {
                        subscribe
                    }
                }

                renderScreen()

                function renderScreen() {

                    context.fillStyle = "cornsilk"
                    context.clearRect(0, 0, 40, 40)

                    for (const playerId in game.state.players) {
                        const player = game.state.players[playerId]
                        context.fillStyle = "black"
                        context.fillRect(player.x, player.y, 1, 1)
                    }

                    for (const frutaId in game.state.frutas) {
                        const fruta = game.state.frutas[frutaId]
                        context.fillStyle = "green"
                        context.fillRect(fruta.x, fruta.y, 1, 1)
                    }

                    requestAnimationFrame(renderScreen)
                }

    </script>
</body>
</html>